/**
 * skylark-widgets-filer - The skylark filer  widget library
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-filer/
 * @license MIT
 */
!function(e,t){var i=t.define,s=t.require,r="function"==typeof i&&i.amd,o=!r&&"undefined"!=typeof exports;if(!r&&!i){var n={};i=t.define=function(e,t,i){"function"==typeof i?(n[e]={factory:i,deps:t.map(function(t){return function(e,t){if("."!==e[0])return e;var i=t.split("/"),s=e.split("/");i.pop();for(var r=0;r<s.length;r++)"."!=s[r]&&(".."==s[r]?i.pop():i.push(s[r]));return i.join("/")}(t,e)}),resolved:!1,exports:null},s(e)):n[e]={factory:null,resolved:!0,exports:i}},s=t.require=function(e){if(!n.hasOwnProperty(e))throw new Error("Module "+e+" has not been defined");var i=n[e];if(!i.resolved){var r=[];i.deps.forEach(function(e){r.push(s(e))}),i.exports=i.factory.apply(t,r)||null,i.resolved=!0}return i.exports}}if(!i)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(e,t){e("skylark-widgets-filer/filer",["skylark-langx/skylark"],function(e){return e.attach("widgets.filer",{})}),e("skylark-widgets-filer/domx/upload",["skylark-langx/types","skylark-langx/objects","skylark-langx/arrays","skylark-langx/Deferred","skylark-langx/Xhr"],function(e,t,i,s,r){return function(i){var o=t.mixin({contentRange:null,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,limitMultiFileUploadSize:void 0,limitMultiFileUploadSizeOverhead:512,sequentialUploads:!1,limitConcurrentUploads:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,autoUpload:!0,messages:{uploadedBytes:"Uploaded bytes exceed file size"},i18n:function(e,i){return e=this.messages[e]||e.toString(),i&&t.each(i,function(t,i){e=e.replace("{"+t+"}",i)}),e},formData:function(e){return e.serializeArray()},add:function(e,t){if(e.isDefaultPrevented())return!1;(t.autoUpload||!1!==t.autoUpload&&$(this).fileupload("option","autoUpload"))&&t.process().done(function(){t.submit()})},processData:!1,contentType:!1,cache:!1},i),n=function(){var e=Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice;return e.apply(this,arguments)},a=function(e){return r.request(e.url,e)};function l(i){var s,r=i.files[0],o=i.multipart,n="array"===e.type(i.paramName)?i.paramName[0]:i.paramName;i.headers=t.mixin({},i.headers),i.contentRange&&(i.headers["Content-Range"]=i.contentRange),o?(s=new FormData,i.blob?s.append(n,i.blob,r.name):t.each(i.files,function(t,r){s.append("array"===e.type(i.paramName)&&i.paramName[t]||n,r,r.uploadName||r.name)}),i.data=s):(i.headers["Content-Disposition"]='attachment; filename="'+encodeURI(r.name)+'"',i.contentType=r.type||"application/octet-stream",i.data=i.blob||r),i.blob=null}function d(e,i){e.uploadedBytes=e.uploadedBytes||0;var r,o,d=e.files[0],p=d.size,u=e.uploadedBytes,c=e.maxChunkSize||p,h=n,f=new s,g=f.promise;return!(!h||!(u||c<p)||e.data)&&(!!i||(u>=p?(d.error=e.i18n("uploadedBytes"),this._getXHRPromise(!1,e.context,[null,"error",d.error])):(o=function(){var i=t.mixin({},e),s=i._progress.loaded;i.blob=h.call(d,u,u+c,d.type),i.chunkSize=i.blob.size,i.contentRange="bytes "+u+"-"+(u+i.chunkSize-1)+"/"+p,l(i),r=a(i).done(function(t,r,n){u=function(e){var t=e.getResponseHeader("Range"),i=t&&t.split("-"),s=i&&i.length>1&&parseInt(i[1],10);return s&&s+1}(n)||u+i.chunkSize,s+i.chunkSize-i._progress.loaded&&f.progress({lengthComputable:!0,loaded:u-i.uploadedBytes,total:u-i.uploadedBytes}),e.uploadedBytes=i.uploadedBytes=u,i.result=t,i.textStatus=r,i.jqXHR=n,u<p?o():f.resolveWith(i.context,[t,r,n])}).fail(function(e,t,s){i.jqXHR=e,i.textStatus=t,i.errorThrown=s,f.rejectWith(i.context,[e,t,s])})},g.abort=function(){return r.abort()},o(),g)))}p=o,p.type=p.type||"POST",d(p,!0)||p.data||l(p),o._bitrateTimer=new function(){this.timestamp=Date.now?Date.now():(new Date).getTime(),this.loaded=0,this.bitrate=0,this.getBitrate=function(e,t,i){var s=e-this.timestamp;return(!this.bitrate||!i||s>i)&&(this.bitrate=(t-this.loaded)*(1e3/s)*8,this.loaded=t,this.timestamp=e),this.bitrate}};var p;var u=d(o)||a(o);return u.options=o,u}}),e("skylark-widgets-filer/domx/uploader",["skylark-langx/langx","skylark-domx-eventer","skylark-domx-query","skylark-domx-files/dropzone","skylark-domx-files/pastezone","skylark-domx-files/picker","./upload"],function(e,t,i,s,r,o,n){"use strict";var a=e.Deferred,l=e.Evented.inherit({options:{dropZone:i(document),pasteZone:i(document),picker:void 0,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,limitMultiFileUploadSize:void 0,limitMultiFileUploadSizeOverhead:512,sequentialUploads:!1,limitConcurrentUploads:void 0,postMessage:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,autoUpload:!1,messages:{uploadedBytes:"Uploaded bytes exceed file size"},i18n:function(t,i){return t=this.messages[t]||t.toString(),i&&e.each(i,function(e,i){t=t.replace("{"+e+"}",i)}),t},formData:function(e){return e.serializeArray()},add:function(e,t){if(e.isDefaultPrevented())return!1;(t.autoUpload||!1!==t.autoUpload&&i(this).fileupload("instance").option("autoUpload"))&&t.process().done(function(){t.submit()})},processData:!1,contentType:!1,cache:!1},_specialOptions:["picker","dropZone","pasteZone","multipart","filesContainer","uploadTemplateId","downloadTemplateId"],_BitrateTimer:function(){this.timestamp=Date.now?Date.now():(new Date).getTime(),this.loaded=0,this.bitrate=0,this.getBitrate=function(e,t,i){var s=e-this.timestamp;return(!this.bitrate||!i||s>i)&&(this.bitrate=(t-this.loaded)*(1e3/s)*8,this.loaded=t,this.timestamp=e),this.bitrate}},_getTotal:function(t){var i=0;return e.each(t,function(e,t){i+=t.size||1}),i},_initProgressObject:function(t){var i={loaded:0,total:0,bitrate:0};t._progress?e.extend(t._progress,i):t._progress=i},_initResponseObject:function(e){var t;if(e._response)for(t in e._response)e._response.hasOwnProperty(t)&&delete e._response[t];else e._response={}},_onProgress:function(e,i){if(e.lengthComputable){var s,r=Date.now?Date.now():(new Date).getTime();if(i._time&&i.progressInterval&&r-i._time<i.progressInterval&&e.loaded!==e.total)return;i._time=r,s=Math.floor(e.loaded/e.total*(i.chunkSize||i._progress.total))+(i.uploadedBytes||0),this._progress.loaded+=s-i._progress.loaded,this._progress.bitrate=this._bitrateTimer.getBitrate(r,this._progress.loaded,i.bitrateInterval),i._progress.loaded=i.loaded=s,i._progress.bitrate=i.bitrate=i._bitrateTimer.getBitrate(r,s,i.bitrateInterval),this._trigger("progress",t.create("progress",{delegatedEvent:e}),i),this._trigger("progressall",t.create("progressall",{delegatedEvent:e}),this._progress)}},_getParamName:function(t){i(t.picker);var s=t.paramName;return e.isArray(s)||(s=[s]),s},_getDeferredState:function(e){return e.state?e.state():e.isResolved()?"resolved":e.isRejected()?"rejected":"pending"},_enhancePromise:function(e){return e.success=e.done,e.error=e.fail,e.complete=e.always,e},_getXHRPromise:function(e,t,i){var s=new a,r=s.promise;return t=t||this.options.context||r,!0===e?s.resolveWith(t,i):!1===e&&s.rejectWith(t,i),r.abort=s.promise,this._enhancePromise(r)},_addConvenienceMethods:function(e,i){var s=this,r=function(e){return(new a).resolveWith(s,e).promise};i.process=function(e,t){return(e||t)&&(i._processQueue=this._processQueue=(this._processQueue||r([this])).pipe(function(){return i.errorThrown?(new a).rejectWith(s,[i]).promise:r(arguments)}).pipe(e,t)),this._processQueue||r([this])},i.submit=function(){return"pending"!==this.state()&&(i.jqXHR=this.jqXHR=!1!==s._trigger("submit",t.create("submit",{delegatedEvent:e}),this)&&s._onSend(e,this)),this.jqXHR||s._getXHRPromise()},i.abort=function(){return this.jqXHR?this.jqXHR.abort():(this.errorThrown="abort",s._trigger("fail",null,this),s._getXHRPromise(!1))},i.state=function(){return this.jqXHR?s._getDeferredState(this.jqXHR):this._processQueue?s._getDeferredState(this._processQueue):void 0},i.processing=function(){return!this.jqXHR&&this._processQueue&&"pending"===s._getDeferredState(this._processQueue)},i.progress=function(){return this._progress},i.response=function(){return this._response}},_beforeSend:function(e,t){0===this._active&&(this._trigger("start"),this._bitrateTimer=new this._BitrateTimer,this._progress.loaded=this._progress.total=0,this._progress.bitrate=0),this._initResponseObject(t),this._initProgressObject(t),t._progress.loaded=t.loaded=t.uploadedBytes||0,t._progress.total=t.total=this._getTotal(t.files)||1,t._progress.bitrate=t.bitrate=0,this._active+=1,this._progress.loaded+=t.loaded,this._progress.total+=t.total},_onDone:function(e,i,s,r){var o=r._progress.total,n=r._response;r._progress.loaded<o&&this._onProgress(t.create("progress",{lengthComputable:!0,loaded:o,total:o}),r),n.result=r.result=e,n.textStatus=r.textStatus=i,n.jqXHR=r.jqXHR=s,this._trigger("done",null,r)},_onFail:function(e,t,i,s){var r=s._response;s.recalculateProgress&&(this._progress.loaded-=s._progress.loaded,this._progress.total-=s._progress.total),r.jqXHR=s.jqXHR=e,r.textStatus=s.textStatus=t,r.errorThrown=s.errorThrown=i,this._trigger("fail",null,s)},_trigger:function(e,i,s){var r=t.proxy(i);return r.type=e,r.data=s,this.trigger(r,s)},_onAlways:function(e,t,i,s){this._trigger("always",null,s)},_onSend:function(e,t){t.submit||this._addConvenienceMethods(e,t);var i,s=this;return this._beforeSend(e,t),s._sending+=1,t.url=s.options.url,t.dataType=s.options.dataType,t.xhrFields=s.options.xhrFields,(i=n(t)).progress(function(e){s._onProgress(e,i.options)}).done(function(e,t){s._onDone(e,t,i,i.options)}).fail(function(e,t){s._onFail(i,t,e,i.options)}).always(function(){s._sending-=1,s._active-=1,s._trigger("stop")}),i},_onAdd:function(i,s){var r,o,n,a,l=this,d=!0,p=e.extend({},this.options,s),u=s.files,c=u.length,h=p.limitMultiFileUploads,f=p.limitMultiFileUploadSize,g=p.limitMultiFileUploadSizeOverhead,m=0,_=this._getParamName(p),v=0;if(!f||c&&void 0!==u[0].size||(f=void 0),p.singleFileUploads||h||f)if(p.singleFileUploads||f||!h)if(!p.singleFileUploads&&f)for(n=[],r=[],a=0;a<c;a+=1)m+=u[a].size+g,(a+1===c||m+u[a+1].size+g>f||h&&a+1-v>=h)&&(n.push(u.slice(v,a+1)),(o=_.slice(v,a+1)).length||(o=_),r.push(o),v=a+1,m=0);else r=_;else for(n=[],r=[],a=0;a<c;a+=h)n.push(u.slice(a,a+h)),(o=_.slice(a,a+h)).length||(o=_),r.push(o);else n=[u],r=[_];return s.originalFiles=u,e.each(n||u,function(o,a){var p=e.extend({},s);return p.files=n?a:[a],p.paramName=r[o],l._initResponseObject(p),l._initProgressObject(p),l._addConvenienceMethods(i,p),d=l._trigger("add",t.create("add",{delegatedEvent:i}),p)}),d},_initEventHandlers:function(){var e=this;s(this.options.dropZone[0],{dropped:function(t){var i={};i.files=t,e._onAdd(null,i)}}),r(this.options.pasteZone[0],{pasted:function(t){var i={};i.files=t,e._onAdd(null,i)}}),o(this.options.picker[0],{multiple:!0,picked:function(t){var i={};i.files=t,e._onAdd(null,i)}})},_destroyEventHandlers:function(){},_setOption:function(t,i){var s=-1!==e.inArray(t,this._specialOptions);s&&this._destroyEventHandlers(),this._super(t,i),s&&(this._initSpecialOptions(),this._initEventHandlers())},_initSpecialOptions:function(){var e=this.options;e.picker&&(e.picker instanceof i||(e.picker=i(e.picker,this._elm))),e.dropZone&&(e.dropZone instanceof i||(e.dropZone=i(e.dropZone,this._elm))),e.pasteZone&&(e.pasteZone instanceof i||(e.pasteZone=i(e.pasteZone,this._elm)))},_getRegExp:function(e){var t=e.split("/"),i=t.pop();return t.shift(),new RegExp(t.join("/"),i)},_isRegExpOption:function(t,i){return"url"!==t&&"string"===e.type(i)&&/^\/.*\/[igm]{0,3}$/.test(i)},_construct:function(t,i){this._elm=t,this.options=e.mixin({},this.options,i),this._initSpecialOptions(),this._slots=[],this._sequence=this._getXHRPromise(!0),this._sending=this._active=0,this._initProgressObject(this),this._initEventHandlers()},active:function(){return this._active},progress:function(){return this._progress},add:function(t){t&&!this.options.disabled&&(t.files=e.makeArray(t.files),this._onAdd(null,t))},send:function(t){return t&&!this.options.disabled&&(t.files=e.makeArray(t.files),t.files.length)?this._onSend(null,t):this._getXHRPromise(!1,t&&t.context)}});return function(t,i){var s=new l(t,i);return s.on("all",function(t,r){var o=t.type;e.isFunction(i[o])&&i[o].call(s._elm,t,r)}),s}}),e("skylark-widgets-filer/Uploader",["skylark-langx/langx","skylark-data-collection/ArrayList","./domx/uploader","skylark-domx-query","skylark-widgets-base/Widget","./filer"],function(e,t,i,s,r,o){function n(e){if(0==e)return"0 B";var t=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return(e/Math.pow(1024,t)).toFixed(2)+" "+["B","KB","MB","GB","TB"][t]}function a(e){return new Date(e).toLocaleString()}var l=e.Stateful.inherit({state:"pending",start:function(){this.isPending()&&(this.get("processor").submit(),this.state="running",this.trigger("filestarted",this))},cancel:function(){this.get("processor").abort(),this.destroy(),this.state="canceled",this.trigger("filecanceled",this)},progress:function(e){this.trigger("fileprogress",this.get("processor").progress())},fail:function(e){this.state="error",this.trigger("filefailed",e)},done:function(e){this.state="error",this.trigger("filedone",e)},isPending:function(){return"pending"==this.getState()},isRunning:function(){return"running"==this.getState()},isDone:function(){return"done"==this.getState()},isError:function(){return"error"==this.getState()||"canceled"==this.getState},getState:function(){return this.state}}),d=t.inherit({item:l}),p=r.inherit({className:"upload-manager-file row",options:{selectors:{fileName:".name",fileSize:".size",cancel:".cancel",clear:".clear",progress:".progress",message:".message"}},state:{fileName:String,fileSize:Number},_init:function(){this.processUploadMsg=this.options.processUploadMsg,this.doneMsg=this.options.doneMsg,this.model=this.options.model,this.fileName(this.options.fileName),this.fileSize(this.options.fileSize),this.model.on("destroy",this.close,this),this.model.on("fileprogress",this.updateProgress,this),this.model.on("filefailed",this.hasFailed,this),this.model.on("filedone",this.hasDone,this),this.model.on("all",this.update,this),this.update()},_refresh:function(e){},updateProgress:function(e){var t=parseInt(e.loaded/e.total*100,10),i=n(e.loaded)+" of "+n(e.total);t>=100&&this.processUploadMsg&&(i=this.processUploadMsg),this._velm.$(".progress").find(".bar").css("width",t+"%").parent().find(".progress-label").html(i)},hasFailed:function(e){this._velm.$(".message").html('<i class="icon-error"></i> '+e)},hasDone:function(e){this._velm.$(".message").html('<i class="icon-success"></i> '+(this.doneMsg||"Uploaded"))},update:function(){var e=this.options.selectors,t=this._velm.$(e.size+","+e.cancel),i=this._velm.$(e.progress+","+e.cancel),s=this._velm.$(e.message+","+e.clear);this.model.isPending()?(i.add(s).addClass("hidden"),t.removeClass("hidden")):this.model.isRunning()?(t.add(s).addClass("hidden"),i.removeClass("hidden")):(this.model.isDone()||this.model.isError())&&(t.add(i).addClass("hidden"),s.removeClass("hidden"))},_startup:function(){var e=this;this._velm.$(this.options.selectors.cancel).click(function(){e.model.cancel(),e.collection.remove(e.model)}),this._velm.$(this.options.selectors.clear).click(function(){e.model.destroy(),e.collection.remove(e.model)})},computeData:function(){return s.extend({displaySize:n,displayDate:a},this.model.get("data"))}}),u=r.inherit({klassName:"Uploader",pluginName:"lark.uploader",options:{uploadUrl:"/upload",autoUpload:!1,selectors:{fileList:".file-list",nodata:".file-list .no-data",pickFiles:".file-picker",startUploads:".start-uploads",cancelUploads:".cancel-uploads"},dataType:"json",fileItem:{selectors:{},template:null}},state:{},_init:function(){var t=this,s=(this._files=new d,this._velm.$(this.options.selectors.pickFiles)),t=this;this.uploadProcess=i(this._elm,{dataType:this.options.dataType,url:this.options.uploadUrl,formData:this.options.formData,autoUpload:this.options.autoUpload,singleFileUploads:!0,picker:s,add:function(i,s){s.uploadManagerFiles=[],e.each(s.files,function(e,i){i.id=t.file_id++;var r=new l({data:i,processor:s});s.uploadManagerFiles.push(r),t._files.add(r),t.renderFile(r)})},progress:function(t,i){e.each(i.uploadManagerFiles,function(e,t){t.progress(i)})},fail:function(t,i){e.each(i.uploadManagerFiles,function(e,t){var s="Unknown error";"string"==typeof i.errorThrown?s=i.errorThrown:"object"==typeof i.errorThrown?s=i.errorThrown.message:i.result&&(s=i.result.error?i.result.error:i.result.files&&i.result.files[e]&&i.result.files[e].error?i.result.files[e].error:"Unknown remote error"),t.fail(s)})},done:function(t,i){e.each(i.uploadManagerFiles,function(e,t){t.done(i.result)})}}),this.bindProcessEvents(),this._velm.$(this.options.selectors.cancelUploads).click(function(){for(;t._files.length;)t._files.at(0).cancel()}),this._velm.$(this.options.selectors.startUploads).click(function(){t._files.forEach(function(e){e.start()})}),this._refresh({files:!0}),this._files.on("all",function(){t._refresh({files:!0})})},_refresh:function(e){var t,i,s,r,o=this;e.files&&(t=o.options.selectors,i=o._files,s=o._velm.$(t.cancelUploads+","+t.startUploads),r=o._velm.$(t.nodata),i.count()>0?(s.removeClass("hidden"),r.addClass("hidden")):(s.addClass("hidden"),r.removeClass("hidden")))},renderFile:function(t){var i=new p(s(e.template(this.options.fileItem.template,t.get("data")))[0],{model:t,template:this.options.fileItem.template});i.render(),i.attach(this._velm.$(this.options.selectors.fileList)[0])},bindProcessEvents:function(){}});return o.Uploader=u}),e("skylark-widgets-filer/main",["./filer","./Uploader"],function(e){return e}),e("skylark-widgets-filer",["skylark-widgets-filer/main"],function(e){return e})}(i),!r){var a=s("skylark-langx/skylark");o?module.exports=a:t.skylarkjs=a}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-widgets-filer.js.map
